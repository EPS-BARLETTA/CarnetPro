<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CarnetPro ‚Äî App (single file)</title>
<style>
:root{--ink:#0b1324;--muted:#475569;--border:#e5e7eb;--card:#ffffff;--blue:#2563eb;--green:#16a34a;--red:#dc2626;--amber:#f59e0b;}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#f8fafc;color:var(--ink)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
.h1{font-size:clamp(22px,4vw,30px);font-weight:800}
.sub{color:var(--muted)}
.grid{display:grid;gap:12px}
.tiles{grid-template-columns:repeat(auto-fit,minmax(210px,1fr))}
.tile{display:flex;flex-direction:column;gap:6px;padding:16px;border:1px solid var(--border);border-radius:16px;background:#fff;text-decoration:none;color:inherit}
.tile:hover{outline:2px solid #c7d2fe}
.tile .name{font-weight:800}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.button{appearance:none;border:1px solid var(--border);background:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;text-decoration:none;color:inherit}
.button.primary{background:var(--blue);border-color:var(--blue);color:#fff}
.button.ok{background:var(--green);border-color:var(--green);color:#fff}
.input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px}
textarea.input{min-height:96px}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.footer{margin-top:18px;color:var(--muted);text-align:center}
hr{border:0;border-top:1px solid var(--border);margin:16px 0}
.badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{border:1px solid var(--border);background:#fff;border-radius:12px;min-height:90px;padding:6px}
.day .d{font-weight:700}
.badge-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#2563eb}
.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
.qr-box{padding:12px;border-radius:16px;border:1px dashed var(--border);background:#fff}
.contrast-dark .qr-box{filter:invert(1)}
nav a{cursor:pointer}
.alert{padding:10px 12px;border:1px solid #fbbf24;background:#fffbeb;border-radius:12px;margin-bottom:10px}
small.hint{color:var(--muted);display:block;margin-top:4px}
</style>
</head><body>
<div class="container">
  <div class="header">
    <div>
      <div class="h1">CarnetPro ‚Äî App (single file)</div>
      <div class="sub">Tout-en-un : Identit√©, S√©ance, Calendrier, Export</div>
    </div>
    <nav class="row">
      <a class="button" data-page="home">Accueil</a>
      <a class="button" data-page="identite">Identit√©</a>
      <a class="button primary" data-page="seance">S√©ance</a>
      <a class="button" data-page="calendar">Calendrier</a>
      <a class="button" data-page="export">Partager</a>
    </nav>
  </div>

  <section id="page-home" class="grid tiles">
    <div class="tile" data-page="seance"><div class="name">Saisir une s√©ance</div><div class="sub">Demi-fond, Natation, Escalade, Danse, Football, Volleyball, Basketball, Handball, Badminton, Musculation step</div></div>
    <div class="tile" data-page="calendar"><div class="name">Calendrier</div><div class="sub">Voir par jour / exporter</div></div>
    <div class="tile" data-page="export"><div class="name">Partager</div><div class="sub">QR, CSV, JSON</div></div>
  </section>

  <section id="page-identite" style="display:none">
    <div class="card grid" style="grid-template-columns:1fr 1fr">
      <div><div class="label">Nom</div><input id="nom" class="input" placeholder="DURAND"></div>
      <div><div class="label">Pr√©nom</div><input id="prenom" class="input" placeholder="Lina"></div>
      <div><div class="label">Classe</div><input id="classe" class="input" placeholder="T1"></div>
      <div><div class="label">Sexe</div>
        <select id="sexe" class="input"><option value="">‚Äî</option><option value="F">F</option><option value="M">M</option><option value="Autre">Autre</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <span id="status" class="badge">‚è≥ En attente</span>
      <a class="button primary" data-page="seance">Continuer ‚Üí S√©ance</a>
      <button id="reset" class="button" style="border-color:#ddd">R√©initialiser</button>
    </div>
  </section>

  <section id="page-seance" style="display:none">
    <div id="seance-guard" class="alert" style="display:none">
      ‚ö†Ô∏è Renseigne d‚Äôabord ton identit√© (Nom, Pr√©nom, Classe, Sexe) dans l‚Äôonglet <strong>Identit√©</strong>.
      <small class="hint">Astuce : d√®s que tu tapes, c‚Äôest enregistr√© automatiquement.</small>
    </div>
    <div class="card grid" id="activities" style="grid-template-columns:repeat(auto-fit,minmax(170px,1fr))"></div>
    <div class="card" id="form" style="display:none">
      <div class="h1" id="actTitle">S√©ance</div>
      <div id="fields" class="grid" style="margin-top:10px"></div>
      <hr/>
      <div><div class="label">Notes libres</div><textarea id="notes" class="input" placeholder="Ressenti, objectifs, points √† am√©liorer..."></textarea></div>
      <div class="row" style="margin-top:12px">
        <button id="save" class="button ok">Enregistrer</button>
        <a class="button" data-page="export">Partager</a>
      </div>
    </div>
  </section>

  <section id="page-calendar" style="display:none">
    <div class="row">
      <button id="prev" class="button">‚óÄ</button>
      <div id="mo" class="badge">‚Äî</div>
      <button id="next" class="button">‚ñ∂</button>
    </div>
    <div id="calendar" class="card"></div>
    <div id="list" class="card" style="margin-top:12px"></div>
  </section>

  <section id="page-export" style="display:none">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <div class="h1">QR ‚Äî derni√®re s√©ance</div>
        <div class="qr-wrap">
          <div id="qrBox" class="qr-box"><div id="qrcode"></div></div>
          <div class="row">
            <button id="contrast" class="button">Contraste üåô/‚òÄÔ∏è</button>
            <button id="png" class="button">T√©l√©charger PNG</button>
          </div>
          <div class="sub">QR = objet JSON <code>scanprof.v1</code>.</div>
        </div>
      </div>
      <div class="card">
        <div class="h1">Export CSV / JSON</div>
        <div class="row">
          <button id="csv-last" class="button">CSV ‚Äî derni√®re s√©ance</button>
          <button id="csv-all" class="button">CSV ‚Äî tout</button>
          <button id="json-all" class="button">JSON ‚Äî tout</button>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">CarnetPro ‚Äî single file</div>
</div>

<script>
// --- storage helpers ---
function gpGet(key, fallback=null){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; }catch(e){ return fallback; } }
function gpSet(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function gpRemove(key){ localStorage.removeItem(key); }
const GP_KEYS = { eleve:'eleve', seances:'seances', derniereSeance:'derniereSeance' };
function makeSeance(eleve, activite, champs={}, notes=''){
  return { app:'CarnetPro', version:'1.0', eleve, seance:{ date: champs.date || new Date().toISOString().slice(0,10), activite, champs, notes } };
}
function flattenSeance(s){ const base={Nom:s.eleve?.nom||'','Pr√©nom':s.eleve?.prenom||'',Classe:s.eleve?.classe||'',Sexe:s.eleve?.sexe||'',Activit√©:s.seance?.activite||'',Date:s.seance?.date||'',Notes:s.seance?.notes||''}; for(const [k,v] of Object.entries(s.seance?.champs||{})) base[k]=v; return base; }

// --- simple router ---
const sections = {
  home: document.getElementById('page-home'),
  identite: document.getElementById('page-identite'),
  seance: document.getElementById('page-seance'),
  calendar: document.getElementById('page-calendar'),
  export: document.getElementById('page-export')
};
function show(name){
  Object.values(sections).forEach(s=> s.style.display='none');
  sections[name].style.display='block';
  window.scrollTo(0,0);
  if(name==='seance') guardSeance();
}
document.querySelectorAll('[data-page]').forEach(el=> el.addEventListener('click', (e)=>{ e.preventDefault(); show(el.getAttribute('data-page')); }));
show('home');

// --- identit√© ---
const inputsIds=['nom','prenom','classe','sexe'];
const statusEl = document.getElementById('status');
const saved=gpGet(GP_KEYS.eleve,{});
function identityOk(){ const e=gpGet(GP_KEYS.eleve,{}); return e.nom&&e.prenom&&e.classe&&e.sexe; }
inputsIds.forEach(id=>{ const el=document.getElementById(id); if(!el) return;
  if(saved[id]!==undefined) el.value=saved[id];
  el.addEventListener('input', ()=>{
    const curr=Object.fromEntries(inputsIds.map(x=>[x, (document.getElementById(x)||{}).value?.trim() || '']));
    gpSet(GP_KEYS.eleve, curr);
    if(statusEl) statusEl.textContent = identityOk()? '‚úÖ Enregistr√©' : '‚è≥ En attente';
    guardSeance(); // <-- met √† jour l'√©tat du message d√®s qu'on tape
  });
});
if(statusEl){ statusEl.textContent = identityOk()? '‚úÖ Enregistr√©' : '‚è≥ En attente'; }

document.getElementById('reset')?.addEventListener('click', ()=>{
  gpRemove(GP_KEYS.eleve); gpRemove(GP_KEYS.derniereSeance); gpRemove(GP_KEYS.seances);
  inputsIds.forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  if(statusEl) statusEl.textContent='‚è≥ En attente';
  guardSeance();
  alert('Donn√©es effac√©es');
});

// --- s√©ance ---
function h(tag, attrs={}, children=[]){ const el=document.createElement(tag); Object.entries(attrs||{}).forEach(([k,v])=>{ if(k==='class') el.className=v; else if(k.startsWith('on')&&typeof v==='function') el.addEventListener(k.slice(2), v); else el.setAttribute(k,v); }); (Array.isArray(children)?children:[children]).forEach(c=>{ if(c==null) return; if(typeof c==='string') el.insertAdjacentHTML('beforeend', c); else el.appendChild(c); }); return el; }
const activitiesEl = document.getElementById('activities');
const form = document.getElementById('form');
const fields = document.getElementById('fields');
const actTitle = document.getElementById('actTitle');
const notes = document.getElementById('notes');
const btnSave = document.getElementById('save');
const guard = document.getElementById('seance-guard');

function guardSeance(){
  const ok = identityOk();
  guard.style.display = ok ? 'none' : 'block';
  activitiesEl.style.opacity = ok ? '1' : '0.5';
}

const ACTIVITES = [
  {id:'Demi-fond', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'duree_min', label:'Dur√©e (min)', type:'number', step:'1'},
    {k:'distance_km', label:'Distance (km)', type:'number', step:'0.01'},
    {k:'allure_sec_km', label:'Allure (sec/km)', type:'number', step:'1'},
    {k:'rpe', label:'RPE (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Natation', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'nage', label:'Nage', type:'text'},
    {k:'distance_m', label:'Distance (m)', type:'number', step:'1'},
    {k:'temps_sec', label:'Temps (sec)', type:'number', step:'1'},
    {k:'rpe', label:'RPE (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Escalade', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'type', label:'Voie/Bloc', type:'text'},
    {k:'hauteur_m', label:'Hauteur (m)', type:'number', step:'0.5'},
    {k:'cotation', label:'Cotation', type:'text'},
    {k:'essais', label:'Essais', type:'number', step:'1'},
    {k:'rpe', label:'RPE (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Danse', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'style', label:'Style', type:'text'},
    {k:'duree_min', label:'Dur√©e (min)', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Football', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'poste', label:'Poste', type:'text'},
    {k:'temps_jeu_min', label:'Temps de jeu (min)', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Volleyball', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'poste', label:'Poste', type:'text'},
    {k:'temps_jeu_min', label:'Temps de jeu (min)', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Basketball', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'poste', label:'Poste', type:'text'},
    {k:'temps_jeu_min', label:'Temps de jeu (min)', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Handball', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'poste', label:'Poste', type:'text'},
    {k:'temps_jeu_min', label:'Temps de jeu (min)', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Badminton', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'format', label:'Format (simple/double)', type:'text'},
    {k:'sets', label:'Nombre de sets', type:'number', step:'1'},
    {k:'intensite', label:'Intensit√© (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]},
  {id:'Musculation step', fields:[
    {k:'date', label:'Date', type:'date'},
    {k:'exercice', label:'Exercice', type:'text'},
    {k:'series', label:'S√©ries', type:'number', step:'1'},
    {k:'reps', label:'R√©p√©titions', type:'number', step:'1'},
    {k:'charge_kg', label:'Charge (kg)', type:'number', step:'0.5'},
    {k:'rpe', label:'RPE (1-10)', type:'number', min:'1', max:'10', step:'1'}
  ]}
];
ACTIVITES.forEach(a=>{
  const tile = h('button',{class:'tile', type:'button', onClick:()=>openForm(a)},[
    h('div',{class:'name'},a.id), h('div',{class:'sub'},'Saisir une s√©ance')
  ]);
  activitiesEl.appendChild(tile);
});

function openForm(act){
  actTitle.textContent=act.id; fields.innerHTML='';
  act.fields.forEach(f=>{
    const wrap=h('div',{},[h('div',{class:'label'},f.label)]);
    const input=h('input',{class:'input', id:f.k, type:f.type||'text'});
    if(f.step) input.step=f.step; if(f.min) input.min=f.min; if(f.max) input.max=f.max;
    if(f.type==='date' && !input.value) input.valueAsDate=new Date();
    wrap.appendChild(input); fields.appendChild(wrap);
  });
  notes.value=''; form.style.display='block'; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
}

btnSave?.addEventListener('click', ()=>{
  if(!identityOk()) return alert("Compl√®te d'abord l'identit√© (Nom, Pr√©nom, Classe, Sexe).");
  const title=actTitle.textContent||'';
  if(!title) return alert('Choisis une activit√©.');
  const act=ACTIVITES.find(a=>a.id===title); if(!act) return alert('Choisis une activit√©.');
  const champs={};
  act.fields.forEach(f=>{ const el=document.getElementById(f.k); if(!el) return; const v=el.value; if(v!==''&&v!==undefined) champs[f.k] = (f.type==='number'? Number(v):v); });
  const s=makeSeance(gpGet(GP_KEYS.eleve,{}), title, champs, (document.getElementById('notes').value||''));
  gpSet(GP_KEYS.derniereSeance, s);
  const all=gpGet(GP_KEYS.seances,[]); all.push(s); gpSet(GP_KEYS.seances, all);
  alert('‚úÖ S√©ance enregistr√©e.');
});

// --- calendar (start at Sept 1, 2025) ---
const cal=document.getElementById('calendar'); const list=document.getElementById('list'); const mo=document.getElementById('mo');
let cur=new Date('2025-09-01'); cur.setDate(1);
document.getElementById('prev')?.addEventListener('click', ()=>{cur.setMonth(cur.getMonth()-1);renderCal();});
document.getElementById('next')?.addEventListener('click', ()=>{cur.setMonth(cur.getMonth()+1);renderCal();});
function renderCal(){ if(!cal) return; mo.textContent=cur.toLocaleDateString('fr-FR',{month:'long',year:'numeric'}); const y=cur.getFullYear(), m=cur.getMonth(); const first=(new Date(y,m,1).getDay()||7); const days=new Date(y,m+1,0).getDate(); const seances=gpGet(GP_KEYS.seances,[]); const byDate={}; seances.forEach(s=>{ const d=(s.seance?.date||'').slice(0,10); (byDate[d]=byDate[d]||[]).push(s); }); const grid=document.createElement('div'); grid.className='calendar'; ['L','M','M','J','V','S','D'].forEach(h=>{ const hd=document.createElement('div'); hd.className='day'; hd.style.background='transparent'; hd.style.border='none'; hd.textContent=h; grid.appendChild(hd); }); for(let i=0;i<(first===1?0:first-1);i++){ const d=document.createElement('div'); d.className='day'; d.style.visibility='hidden'; grid.appendChild(d); } for(let d=1; d<=days; d++){ const dateStr=new Date(y,m,d).toISOString().slice(0,10); const cell=document.createElement('div'); cell.className='day'; const top=document.createElement('div'); top.className='d'; top.textContent=d; cell.appendChild(top); if(byDate[dateStr]?.length){ const dot=document.createElement('span'); dot.className='badge-dot'; dot.title=byDate[dateStr].length+' s√©ance(s)'; cell.appendChild(dot); cell.style.cursor='pointer'; cell.onclick=()=>showList(dateStr,byDate[dateStr]); } grid.appendChild(cell); } cal.innerHTML=''; cal.appendChild(grid); list.innerHTML='<div class="sub">S√©lectionne un jour.</div>'; }
function showList(dateStr, arr){ if(!list) return; list.innerHTML = arr.map(s=>{ const act=s.seance?.activite||'‚Äî', notes=(s.seance?.notes||'').replace(/</g,'&lt;'); return `<div class="card" style="margin:6px 0"><div class="row"><strong>${act}</strong><span class="badge">${dateStr}</span></div><div class="sub">${notes}</div></div>`; }).join(''); }
renderCal();

// --- export ---
function toCSVRow(obj){ const headers = Object.keys(obj); const row = headers.map(h=>{ const v = String(obj[h]??''); return /[",\n]/.test(v) ? '"'+v.replace(/"/g,'""')+'"' : v; }).join(','); return headers.join(',')+'\\n'+row; }
function download(name, text, mime='text/plain'){ const blob=new Blob([text],{type:mime+';charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }
document.getElementById('contrast')?.addEventListener('click',()=> document.body.classList.toggle('contrast-dark'));
document.getElementById('png')?.addEventListener('click',()=>{ const c=document.querySelector('#qrcode canvas'); if(!c) return alert('QR non disponible.'); const a=document.createElement('a'); a.download='qr.png'; a.href=c.toDataURL('image/png'); a.click(); });
document.getElementById('csv-last')?.addEventListener('click',()=>{ const s=gpGet(GP_KEYS.derniereSeance,null); if(!s) return alert('Aucune s√©ance.'); const flat=flattenSeance(s); download('seance.csv', toCSVRow(flat), 'text/csv'); });
document.getElementById('csv-all')?.addEventListener('click',()=>{ const arr=gpGet(GP_KEYS.seances,[]).map(flattenSeance); if(!arr.length) return alert('Aucune s√©ance.'); const headers=[...new Set(arr.flatMap(o=>Object.keys(o)))]; const rows=arr.map(o=> headers.map(h=>{ const v=String(o[h]??''); return /[",\n]/.test(v)? '"'+v.replace(/"/g,'""')+'"' : v; }).join(',')).join('\\n'); download('seances.csv', headers.join(',')+'\\n'+rows, 'text/csv'); });
document.getElementById('json-all')?.addEventListener('click',()=> download('seances.json', JSON.stringify(gpGet(GP_KEYS.seances,[]), null, 2), 'application/json'));

// --- QR ---
function makeMiniQR(text){ const pre=document.createElement('pre'); pre.textContent=text; return pre; }
function renderQR(){
  const last = gpGet(GP_KEYS.derniereSeance,null);
  const box = document.getElementById('qrcode'); if(!box) return;
  box.innerHTML='';
  if(!last){ box.innerHTML='<div class="sub">Aucune s√©ance enregistr√©e.</div>'; return; }
  if(window.QRCode){ new window.QRCode(box,{text: JSON.stringify(last), width:320, height:320, correctLevel: window.QRCode.CorrectLevel.M}); }
  else { box.appendChild(makeMiniQR(JSON.stringify(last))); }
}
renderQR();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onload="renderQR()" crossorigin="anonymous"></script>
</body></html>
